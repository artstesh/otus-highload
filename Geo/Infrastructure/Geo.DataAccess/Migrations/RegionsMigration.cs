using Common.DataAccess;
using Dapper;

namespace Geo.DataAccess.Migrations;

public class RegionsMigration : IMigration
{
    private readonly IOtusContextFactory _factory;

    public RegionsMigration(IOtusContextFactory contextFactory)
    {
        _factory = contextFactory;
        MigrationId = Guid.Parse("C50C33B9-4737-4186-8FEF-5C822CF183D0");
    }

    public override void Migrate()
    {
        var exists = _factory.Get().Query<int>(conn =>
        {
            return conn.QueryFirst<int>($"select count(*) from \"Migrations\" where id = '{MigrationId}'");
        }) > 0;

        if (exists) return;

        _factory.Get().Execute(conn => conn.Execute("DROP TABLE IF EXISTS regions;"));
        _factory.Get().Execute(conn =>
            conn.Execute(
                @"CREATE EXTENSION IF NOT EXISTS ""uuid-ossp"";
                  CREATE EXTENSION IF NOT EXISTS postgis;
                  create table regions
                  (
                      id      uuid default uuid_generate_v4() not null,
                      name    varchar                         not null,
                      polygon geometry                        not null
                  );
                  DROP INDEX IF EXISTS idx_regions_polygon;
                  CREATE INDEX idx_regions_polygon ON regions USING GIST(polygon);"));
        _factory.Get().Execute(conn =>
            conn.Execute(
                @"INSERT INTO regions(id, name, polygon) VALUES ('4a49d6fd-18e0-4b7e-ab6c-477bcc4c9085', 'Eastern Province', st_geomfromtext('POLYGON ((30.449699393 -1.04909407, 30.473056975 -1.056804317, 30.451244021 -1.088901728, 30.459096242 -1.117705104, 30.476549588 -1.122130901, 30.470731806 -1.15753728, 30.509421842 -1.171742663, 30.552109373 -1.25294177, 30.568777496 -1.337138998, 30.613321007 -1.349952395, 30.629203909 -1.384359401, 30.678601519 -1.393639298, 30.737921483 -1.445392576, 30.745987855 -1.52205881, 30.83925083 -1.650978007, 30.821462374 -1.693245254, 30.831039704 -1.811385493, 30.80792919 -1.93770513, 30.899746642 -2.078004099, 30.844156484 -2.205781154, 30.857124546 -2.313957401, 30.78166589 -2.39134937, 30.715992765 -2.356757956, 30.658945187 -2.41377579, 30.607519087 -2.400421065, 30.569477454 -2.420319308, 30.510556051 -2.401878486, 30.470700078 -2.366900408, 30.458326881 -2.319251701, 30.429922066 -2.329215694, 30.408506917 -2.310715385, 30.380905169 -2.326479314, 30.374361651 -2.356014373, 30.28007551 -2.375972102, 30.242448085 -2.360018493, 30.199046715 -2.38846495, 30.184163186 -2.429082349, 30.127805652 -2.437612717, 30.063024826 -2.394032888, 30.034542679 -2.351702277, 29.959208987 -2.326913976, 29.990287373 -2.218481634, 29.983317542 -2.155474036, 30.01813387 -2.118183604, 30.019346429 -2.074182666, 30.046707138 -2.05467043, 30.076877177 -2.069253296, 30.17302093 -2.028258743, 30.208068031 -2.079743509, 30.222108775 -2.07211844, 30.233498781 -1.96244248, 30.277055362 -1.935040614, 30.272941898 -1.90010739, 30.258090406 -1.894404798, 30.265230075 -1.864939119, 30.247406906 -1.857153037, 30.259602355 -1.829214161, 30.275623513 -1.830468523, 30.275612457 -1.802335002, 30.247090719 -1.721979733, 30.262960214 -1.708497792, 30.170672617 -1.583877604, 30.162488289 -1.542920152, 30.181339067 -1.51878528, 30.139940858 -1.526868003, 30.133789747 -1.481896078, 30.069929334 -1.382428812, 30.103679609 -1.371978219, 30.123381546 -1.384408523, 30.129263574 -1.362860124, 30.170057054 -1.345195006, 30.171256301 -1.272992641, 30.210793426 -1.27613353, 30.292317083 -1.189319039, 30.307217268 -1.144779336, 30.344622396 -1.131487666, 30.352089144 -1.062228695, 30.42856978 -1.064284549, 30.449699393 -1.04909407))'));
INSERT INTO regions(id, name, polygon) VALUES ('99734c62-f9b5-4f54-a8ce-9118c01d6026', 'Kigali City', st_geomfromtext('POLYGON ((30.147858518 -1.792688687, 30.163922469 -1.790795337, 30.265230075 -1.864939119, 30.258090406 -1.894404798, 30.272941898 -1.90010739, 30.277055362 -1.935040614, 30.233498781 -1.96244248, 30.222108775 -2.07211844, 30.208068031 -2.079743509, 30.172602517 -2.028218894, 30.118906136 -2.059809104, 30.066018234 -2.071251745, 30.04737529 -2.054620937, 30.016336174 -2.075768584, 29.994026746 -2.068348268, 29.98336259 -2.043679346, 30.015506847 -2.012823926, 29.992913823 -1.992762395, 30.00343087 -1.955537777, 29.977519332 -1.881042625, 29.991144576 -1.847507481, 30.015369933 -1.83608534, 30.029369538 -1.865193654, 30.06345825 -1.828838343, 30.118638113 -1.81926312, 30.138108558 -1.779656475, 30.147858518 -1.792688687))'));
INSERT INTO regions(id, name, polygon) VALUES ('616d2e07-1fdb-4f9c-aeb6-be87c3c0e07d', 'Northern Province', st_geomfromtext('POLYGON ((29.830626663 -1.315692228, 29.861964165 -1.360854397, 29.883117573 -1.356476189, 29.885580315 -1.423101097, 29.91486462 -1.482480388, 29.977644318 -1.458780957, 30.023672612 -1.415303446, 30.05291143 -1.43108403, 30.051902538 -1.397866755, 30.074973393 -1.392051899, 30.093633854 -1.41293521, 30.133789747 -1.481896078, 30.139940858 -1.526868003, 30.181339067 -1.51878528, 30.162488289 -1.542920152, 30.170672617 -1.583877604, 30.262960214 -1.708497792, 30.247090719 -1.721979733, 30.275623513 -1.830468523, 30.218378935 -1.841464232, 30.138497836 -1.779561419, 30.118638113 -1.81926312, 30.06345825 -1.828838343, 30.029369538 -1.865193654, 30.015369933 -1.83608534, 29.991144576 -1.847507481, 29.982840277 -1.913378329, 29.910140166 -1.857343903, 29.879857819 -1.854031795, 29.851493369 -1.873076291, 29.841038518 -1.857181207, 29.798067306 -1.848926211, 29.747915375 -1.750657831, 29.716649779 -1.755322824, 29.694864342 -1.733688599, 29.654926737 -1.735177816, 29.635588858 -1.719354401, 29.638545338 -1.592284044, 29.585627887 -1.592004962, 29.559237551 -1.569915587, 29.499165002 -1.563661676, 29.450034602 -1.506084628, 29.55723597 -1.389762941, 29.660162077 -1.393429219, 29.734544028 -1.340272059, 29.796362424 -1.372775497, 29.796790728 -1.349837493, 29.820870872 -1.310861922, 29.830626663 -1.315692228))'));
INSERT INTO regions(id, name, polygon) VALUES ('fa56e62e-191c-4438-b132-7d9c46b24cf1', 'Southern Province', st_geomfromtext('POLYGON ((29.668112721 -1.73117765, 29.717446899 -1.755525078, 29.747915375 -1.750657831, 29.800902786 -1.850785954, 29.841038518 -1.857181207, 29.852562791 -1.87329715, 29.879857819 -1.854031795, 29.910140166 -1.857343903, 29.942364085 -1.877992602, 29.962882096 -1.907621432, 29.977196663 -1.905778776, 30.003306755 -1.954858412, 29.992991228 -1.993226818, 30.015506847 -2.012823926, 29.983651645 -2.057844008, 30.019346429 -2.074182666, 30.020810133 -2.111764071, 29.985576717 -2.147765075, 29.990287373 -2.218481634, 29.944384902 -2.366692882, 29.970903994 -2.461419224, 29.921434999 -2.557573243, 29.928966908 -2.672335334, 29.879331352 -2.759970882, 29.832075256 -2.782242637, 29.807186095 -2.7607799, 29.772731499 -2.766062303, 29.75343407 -2.811938311, 29.708248105 -2.819957094, 29.648166715 -2.787667809, 29.616186759 -2.810582018, 29.588632601 -2.803205689, 29.521389034 -2.830331544, 29.486030243 -2.802563234, 29.438107898 -2.798089849, 29.370626384 -2.840087335, 29.333078489 -2.747050409, 29.354588817 -2.730132442, 29.327891265 -2.689824372, 29.349074483 -2.676729408, 29.367723689 -2.630327917, 29.342542747 -2.593157281, 29.339225832 -2.540140866, 29.319084844 -2.537786643, 29.322543243 -2.507551125, 29.265624239 -2.472315808, 29.280307962 -2.441856185, 29.325297049 -2.430042284, 29.318287587 -2.398644652, 29.343969092 -2.35998939, 29.320192983 -2.320938357, 29.34414793 -2.292570279, 29.386347869 -2.298049704, 29.421411738 -2.267060625, 29.469551834 -2.273740935, 29.551346516 -2.199826535, 29.606282524 -2.187851533, 29.594551781 -2.150660558, 29.639252019 -2.049454365, 29.622394404 -1.975796755, 29.654632924 -1.976303718, 29.673649156 -1.959425923, 29.660941251 -1.938273924, 29.67517392 -1.896267772, 29.663322665 -1.861298766, 29.668112721 -1.73117765))'));
INSERT INTO regions(id, name, polygon) VALUES ('ce83893d-e521-40e7-bbaf-22919cbf5076', 'Western Province', st_geomfromtext('POLYGON ((29.450090203 -1.506149206, 29.499165002 -1.563661676, 29.559237551 -1.569915587, 29.585627887 -1.592004962, 29.638545338 -1.592284044, 29.634206391 -1.714640688, 29.664773148 -1.742020854, 29.67332235 -1.78098006, 29.663322665 -1.861298766, 29.67517392 -1.896267772, 29.660941251 -1.938273924, 29.673649156 -1.959425923, 29.654632924 -1.976303718, 29.622394404 -1.975796755, 29.639252019 -2.049454365, 29.594551781 -2.150660558, 29.609114082 -2.180736945, 29.585164807 -2.201914148, 29.551346516 -2.199826535, 29.469551834 -2.273740935, 29.421100071 -2.267138542, 29.386347869 -2.298049704, 29.34414793 -2.292570279, 29.320615349 -2.319978435, 29.343969092 -2.35998939, 29.318287587 -2.398644652, 29.32866989 -2.421651369, 29.280307962 -2.441856185, 29.264653413 -2.482024054, 29.30716174 -2.492897741, 29.322543243 -2.507551125, 29.319149752 -2.537940062, 29.339225832 -2.540140866, 29.342542747 -2.593157281, 29.367930538 -2.631379823, 29.349074483 -2.676729408, 29.329055486 -2.682622036, 29.326201847 -2.653537592, 29.265335234 -2.61884505, 29.220434805 -2.632312799, 29.173773575 -2.615585188, 29.162899438 -2.595573921, 29.127945156 -2.610588321, 29.088945789 -2.592028525, 29.053468026 -2.619344737, 29.057346548 -2.709835639, 29.040499964 -2.744670948, 28.995694713 -2.69936601, 28.9666177 -2.703530067, 28.897279968 -2.660391153, 28.898671952 -2.580798182, 28.861837896 -2.52372681, 28.889249287 -2.50452456, 28.90834875 -2.408390656, 28.948709524 -2.383975705, 28.969609656 -2.405028855, 28.9877216 -2.376660149, 29.004570246 -2.376196304, 29.019050944 -2.296460961, 29.032872841 -2.291530531, 29.053907714 -2.3133717, 29.042701424 -2.344803343, 29.061583702 -2.370680122, 29.038655627 -2.403266396, 29.049037777 -2.414138165, 29.07927474 -2.373264188, 29.083539317 -2.340219209, 29.067425933 -2.336024664, 29.106241444 -2.336391156, 29.105057298 -2.309789226, 29.127655742 -2.295771081, 29.112979248 -2.331754958, 29.122730477 -2.341688444, 29.141970768 -2.295482324, 29.159849017 -2.297334328, 29.166773912 -2.259216251, 29.179810319 -2.255739265, 29.180485412 -2.271194804, 29.190271801 -2.255814217, 29.207484112 -2.263734866, 29.207126471 -2.24484807, 29.201300621 -2.255561187, 29.182483737 -2.246803039, 29.19371256 -2.20542046, 29.21835416 -2.212287907, 29.197652344 -2.186311048, 29.217938003 -2.175035428, 29.210439764 -2.162525447, 29.242580726 -2.169329151, 29.246865612 -2.150175734, 29.281805469 -2.18996095, 29.250026846 -2.135651126, 29.268996014 -2.086805427, 29.276068325 -2.147418696, 29.29016611 -2.135526084, 29.280233364 -2.087127543, 29.313539684 -2.087133521, 29.325942953 -2.114627191, 29.326429292 -2.097777459, 29.337264512 -2.101200403, 29.316963368 -2.069977067, 29.340483127 -2.066079248, 29.324643451 -2.055862882, 29.346763574 -2.062175237, 29.338036261 -2.048608006, 29.350429442 -2.047285414, 29.354071484 -2.071525149, 29.373073829 -2.072584294, 29.358796513 -2.063605412, 29.370982383 -2.045205959, 29.356149029 -2.041703236, 29.381863796 -2.037109004, 29.360000268 -2.030875251, 29.364040008 -2.01911616, 29.353195616 -2.027664373, 29.358140876 -2.007460094, 29.343248401 -1.998110284, 29.35441451 -1.991002761, 29.329055629 -1.984879128, 29.32393624 -1.926658223, 29.302730148 -1.944773888, 29.270614829 -1.89717038, 29.297324117 -1.847392556, 29.267891296 -1.774533867, 29.290009749 -1.772866143, 29.272653734 -1.767777197, 29.279376691 -1.735858069, 29.255342201 -1.729241904, 29.269066741 -1.714548346, 29.244939046 -1.697964147, 29.242866738 -1.668074615, 29.310372047 -1.599974442, 29.361649431 -1.509198004, 29.450090203 -1.506149206))'));
"));
        _factory.Get().Execute(conn => conn.Execute($"insert into \"Migrations\" (id) values ('{MigrationId}');"));
    }
}
